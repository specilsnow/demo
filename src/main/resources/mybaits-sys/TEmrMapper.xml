<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cdutcm.tcms.biz.mapper.TEmrMapper">
    <resultMap id="BaseEmrResultMap" type="com.cdutcm.tcms.junqu.model.EmrView">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue May 08 14:17:10 CST 2018.
    -->
    <result column="VISIT_NO" jdbcType="DECIMAL" property="visitNo" />
    <result column="VISIT_DATE" jdbcType="TIMESTAMP" property="visitDate" />
    <result column="PATIENT_ID" jdbcType="VARCHAR" property="patientId" />
    <result column="DIAG_DESC" jdbcType="VARCHAR" property="diagDesc" />
    <result column="ILLNESS_DESC" jdbcType="VARCHAR" property="illnessDesc" />
    <result column="ANAMNESIS" jdbcType="VARCHAR" property="anamnesis" />
    <result column="FAMILY_ILL" jdbcType="VARCHAR" property="familyIll" />
    <result column="MARRITAL" jdbcType="VARCHAR" property="marrital" />
    <result column="INDIVIDUAL" jdbcType="VARCHAR" property="individual" />
    <result column="MENSES" jdbcType="VARCHAR" property="menses" />
    <result column="MED_HISTORY" jdbcType="VARCHAR" property="medHistory" />
  </resultMap>

  <resultMap id="BasePatientResultMap" type="com.cdutcm.tcms.junqu.model.PatientView">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue May 08 14:16:07 CST 2018.
    -->
    <id column="VISIT_NO" jdbcType="DECIMAL" property="visitNo" />
    <result column="PATIENT_ID" jdbcType="VARCHAR" property="patientId" />
    <result column="NAME" jdbcType="VARCHAR" property="name" />
    <result column="NAME_PHONETIC" jdbcType="VARCHAR" property="namePhonetic" />
    <result column="SEX" jdbcType="VARCHAR" property="sex" />
    <result column="DATE_OF_BIRTH" jdbcType="TIMESTAMP" property="dateOfBirth" />
    <result column="MAILING_ADDRESS" jdbcType="VARCHAR" property="mailingAddress" />
    <result column="PHONE_NUMBER_HOME" jdbcType="VARCHAR" property="phoneNumberHome" />
    <result column="VISIT_DATE" jdbcType="TIMESTAMP" property="visitDate" />
    <result column="SERIAL_NO" jdbcType="DECIMAL" property="serialNo" />
    <result column="CLINIC_LABEL" jdbcType="VARCHAR" property="clinicLabel" />
    <result column="FIRST_VISIT_INDICATOR" jdbcType="DECIMAL" property="firstVisitIndicator" />
    <result column="VISIT_DEPT" jdbcType="VARCHAR" property="visitDept" />
    <result column="DEPT_NAME" jdbcType="VARCHAR" property="deptName" />
    <result column="DOCTOR" jdbcType="VARCHAR" property="doctor" />
    <result column="REGISTERING_DAT" jdbcType="TIMESTAMP" property="registeringDat" />
  </resultMap>
    
   <resultMap id="BaseRecipelResultMap" type="com.cdutcm.tcms.junqu.model.RecipelView">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue May 08 11:55:35 CST 2018.
    -->
    <result column="VISIT_DATE" jdbcType="TIMESTAMP" property="visitDate" />
    <result column="VISIT_NO" jdbcType="VARCHAR" property="visitNo" />
    <result column="ITEM_NO" jdbcType="DECIMAL" property="itemNo" />
    <result column="ITEM_CLASS" jdbcType="VARCHAR" property="itemClass" />
    <result column="DRUG_CODE" jdbcType="VARCHAR" property="drugCode" />
    <result column="DRUG_NAME" jdbcType="VARCHAR" property="drugName" />
    <result column="AMOUNT" jdbcType="DECIMAL" property="amount" />
    <result column="UNITS" jdbcType="VARCHAR" property="units" />
    <result column="REPETITION" jdbcType="DECIMAL" property="repetition" />
    <result column="DOSAGE" jdbcType="DECIMAL" property="dosage" />
    <result column="DOSAGE_UNITS" jdbcType="VARCHAR" property="dosageUnits" />
    <result column="ADMINISTRATION" jdbcType="VARCHAR" property="administration" />
    <result column="FREQUENCY" jdbcType="VARCHAR" property="frequency" />
    <result column="DISPENSARY" jdbcType="VARCHAR" property="dispensary" />
    <result column="SERIAL_NO" jdbcType="VARCHAR" property="serialNo" />
  </resultMap>
  
   <resultMap type="com.cdutcm.tcms.biz.model.PatientRegist"  id="patientRegistResult" >
    <id column="pid" property="id" jdbcType="BIGINT" />
    <result column="ys" property="ys" jdbcType="VARCHAR" />
    <result column="ysbm" property="ysbm" jdbcType="VARCHAR" />
    <result column="ghks" property="ghks" jdbcType="VARCHAR" />
    <result column="ghksbm" property="ghksbm" jdbcType="VARCHAR" />
    <result column="patient_no" property="patientNo" jdbcType="VARCHAR" />
    <result column="pvisit_no" property="visitNo" jdbcType="VARCHAR" />
    <result column="kssj" property="kssj" jdbcType="TIMESTAMP" />
    <result column="io" property="io" jdbcType="VARCHAR" />
  </resultMap>
  <resultMap id="IllnessResult" type="com.cdutcm.tcms.biz.model.IllnessHistory" >
    <result column="id" property="id" jdbcType="BIGINT" />
    <result column="ichief_complaint" property="chiefComplaint" jdbcType="VARCHAR" />
    <result column="present_illness" property="presentIllness" jdbcType="VARCHAR" />
    <result column="passed_illness" property="passedIllness" jdbcType="VARCHAR" />
    <result column="personal_illness" property="personalIllness" jdbcType="VARCHAR" /> 
    <result column="menstruation_History" property="menstruationHistory" jdbcType="VARCHAR" /> 
    <result column="marriage_history" property="marriageHistory" jdbcType="VARCHAR" />
    <result column="allergic_history" property="allergicHistory" jdbcType="VARCHAR" />
    <result column="family_history" property="familyHistory" jdbcType="VARCHAR" />
  </resultMap>
  <resultMap id="PatientResult" type="com.cdutcm.tcms.biz.model.Patient" >
  	 <id column="cid" property="id" jdbcType="BIGINT" />
    <result column="cpatient_no" property="patientNo" jdbcType="VARCHAR" />
    <result column="cname" property="name" jdbcType="VARCHAR" />
    <result column="sex" property="sex" jdbcType="VARCHAR" />
    <result column="birthday" property="birthday" jdbcType="VARCHAR" />
    <result column="address" property="address" jdbcType="VARCHAR" />
    <result column="telephone" property="telephone" jdbcType="VARCHAR" />
    <result column="card_no" property="cardNo" jdbcType="VARCHAR" />
    <result column="note" property="note" jdbcType="VARCHAR" />
    <result column="ye" property="ye" jdbcType="INTEGER" />
  </resultMap>
    <resultMap id="BaseEmrMap" type="com.cdutcm.tcms.biz.model.Emr">
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="disease" property="disease" jdbcType="VARCHAR" />
    <result column="symptommould" property="symptommould" jdbcType="VARCHAR" />
    <result column="symptom" property="symptom" jdbcType="VARCHAR" />
    <result column="fs_code" property="fsCode" jdbcType="VARCHAR" />
    <result column="chief_complaint" property="chiefComplaint" jdbcType="VARCHAR" />
    <result column="illness_history_id" property="illnessHistoryId" jdbcType="BIGINT" />
    <result column="bw" property="bw" jdbcType="VARCHAR" />
    <result column="bx" property="bx" jdbcType="VARCHAR" />
    <result column="therapy" property="therapy" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="patient_no" property="patientNo" jdbcType="VARCHAR" />
    <result column="visit_no" property="visitNo" jdbcType="VARCHAR" />
    <result column="patient_name" property="patientName" jdbcType="VARCHAR" />
    <result column="doctor_id" property="doctorId" jdbcType="VARCHAR" />
    <result column="doctor_name" property="doctorName" jdbcType="VARCHAR" />
    <result column="dept_id" property="deptId" jdbcType="VARCHAR" />
    <result column="dept_name" property="deptName" jdbcType="VARCHAR" />
    <result column="end_time" property="endTime" jdbcType="TIMESTAMP" /> 
    <association column="illnessHistory" property="illnessHistory"  javaType="com.cdutcm.tcms.biz.model.IllnessHistory" resultMap="IllnessResult"/>
    <association column="patient" property="patient"  javaType="com.cdutcm.tcms.biz.model.Patient" resultMap="PatientResult"/>
    <association column="patientRegist" property="patientRegist"  javaType="com.cdutcm.tcms.biz.model.PatientRegist" resultMap="patientRegistResult"/>
    <collection property="recipels" column="recipels" ofType="com.cdutcm.tcms.biz.model.Recipel">
         <result column="recipel_no" property="recipelNo" jdbcType="VARCHAR" />
         <collection column="recipelitem" property="recipelItems"  ofType="com.cdutcm.tcms.biz.model.RecipelItem">
           <result column="reid" property="id" jdbcType="VARCHAR" />
           <result column="rid" property="recipelId" jdbcType="VARCHAR" />
           <result column="name" property="name" jdbcType="VARCHAR" />
           <result column="dosage" property="dosage" jdbcType="VARCHAR" />
           <result column="unit" property="unit" jdbcType="VARCHAR" />
           <result column="usage" property="usage" jdbcType="VARCHAR" />
         </collection>
    </collection>
  </resultMap>
  <insert id="addPatinetList" useGeneratedKeys="true" parameterType="java.util.List"> 
	    insert into V_ZYY_CLINIC_MASTER (PATIENT_ID,NAME,NAME_PHONETIC,SEX,DATE_OF_BIRTH,MAILING_ADDRESS,PHONE_NUMBER_HOME,
	                                      VISIT_DATE,SERIAL_NO,VISIT_NO,CLINIC_LABEL,FIRST_VISIT_INDICATOR,VISIT_DEPT,
	                                      DEPT_NAME,DOCTOR,REGISTERING_DAT) 
	         values 
		<foreach collection="list" item="item" index="index" separator="," > 
		(#{item.patientId},#{item.name},#{item.namePhonetic},#{item.sex},#{item.dateOfBirth},#{item.mailingAddress},#{item.phoneNumberHome},
		#{item.visitDate},#{item.serialNo},concat(date_format(#{item.visitDate}, '%Y%m%d'),#{item.visitNo}),#{item.clinicLabel},#{item.firstVisitIndicator},#{item.visitDept},
		#{item.deptName},#{item.doctor},#{item.registeringDat})  
		</foreach> 
  </insert>
   <insert id="addEmrList" useGeneratedKeys="true" parameterType="java.util.List"> 
	    insert into V_ZYY_OUTP_MR (VISIT_NO,VISIT_DATE,PATIENT_ID,DIAG_DESC,ILLNESS_DESC,ANAMNESIS,FAMILY_ILL,
	                                     MARRITAL,INDIVIDUAL,MENSES,MED_HISTORY) 
	         values 
		<foreach collection="list" item="item" index="index" separator="," > 
		(concat(date_format(#{item.visitDate}, '%Y%m%d'),#{item.visitNo}),#{item.visitDate},#{item.patientId},#{item.diagDesc},#{item.illnessDesc},#{item.anamnesis},#{item.familyIll},
		#{item.marrital},#{item.individual},#{item.menses},#{item.medHistory})  
		</foreach> 
  </insert>
    <insert id="addRecipelList" useGeneratedKeys="true" parameterType="java.util.List"> 
	    insert into V_ZYY_OUTP_PREC (VISIT_DATE,VISIT_NO,ITEM_NO,ITEM_CLASS,DRUG_CODE,DRUG_NAME,AMOUNT,
	                                      UNITS,REPETITION,DOSAGE,DOSAGE_UNITS,ADMINISTRATION,FREQUENCY,
	                                      DISPENSARY,SERIAL_NO) 
	         values 
		<foreach collection="list" item="item" index="index" separator="," > 
		(#{item.visitDate},concat(date_format(#{item.visitDate}, '%Y%m%d'),#{item.visitNo}),#{item.itemNo},#{item.itemClass},#{item.drugCode},#{item.drugName},#{item.amount},
		#{item.units},#{item.repetition},#{item.dosage},#{item.dosageUnits},#{item.administration},#{item.frequency},
		#{item.dispensary},#{item.serialNo})  
		</foreach> 
  </insert>
  <select id="findPatientByLastLastVisit" resultType="string" parameterType="string">
     select VISIT_NO from V_ZYY_CLINIC_MASTER where VISIT_DATE=#{_parameter}  order by VISIT_NO desc limit 1
  </select>
  
    <select id="findEmrByDate" resultMap="BaseEmrMap" parameterType="string">
	      select c.serial_no as id ,b.diag_desc as disease,b.illness_desc as chief_complaint,c.visit_no as visit_no,
	       a.patient_id as patientNo,a.name as patient_name,a.doctor as doctor_id, a.dept_name as dept_name,
	       a.visit_dept as dept_id,c.visit_date as end_time,c.serial_no as recipel_no,c.serial_no as reid,
	       c.serial_no as rid,c.drug_name as name, c.dosage as dosage, c.dosage_units as unit,a.patient_id as patient_no,
	       a.visit_no as pvisit_no, a.dept_name as ys,a.dept_name as ghks, a.visit_dept as ghksbm,
	       a.patient_id as cpatient_no, a.name as cname, a.sex as sex, a.mailing_address as address, a.phone_number_home as telephone,
	       a.date_of_birth as birthday,b.illness_desc as ichief_complaint, b.anamnesis as passed_illness, b.family_ill as family_history,
	       b.marrital as marriage_history, b.individual as personal_illness, b.menses as menstruation_History
	       from v_zyy_clinic_master a left join v_zyy_outp_mr b on a.visit_no = b.visit_no left join v_zyy_outp_prec  c on c.visit_no = b.visit_no 
           where 
	       c.visit_date =str_to_date(#{_parameter},'%Y-%m-%d')
   </select>
</mapper>