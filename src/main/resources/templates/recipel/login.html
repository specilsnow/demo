<head>
    <title>登录</title>
    <meta name="content-type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="css/iconfont.css">
    <link href="metronic/css/font-awesome.min.css" rel="stylesheet"/>
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet"
          type="text/css"/>
    <link rel="stylesheet" type="text/css" href="css/index_zskf.css">
    <!--<link rel="stylesheet" type="text/css" href="layui/css-red/layui.css">-->
    <!--H5禁止缩放-->
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/>
</head>
<body>
<div class="logincontent">
    <div class="logo"><img src="img/logo_mobile.png"></div>
    <div id="go" class="regist-content">
        <h1>登录</h1>
        <div class="form">
            <ul class="nav nav-tabs" role="tablist" id="login-type">
                <li role="presentation"><a href="#passwordLogin" aria-controls="passwordLogin" role="tab"
                                                          data-toggle="tab">账号密码登录</a></li>
                <li role="presentation" class="active"><a href="#messageLogin" aria-controls="messageLogin" role="tab"
                                           data-toggle="tab">短信验证登录</a>
                </li>
            </ul>
            <div class="tab-content">
                <div role="tabpanel" class="tab-pane" id="passwordLogin">
                    <form action="${request.contextPath}/userlogin" method="post" id="loginForm">
                        <div class="regist-content-item">
                            <i class="glyphicon glyphicon-user" aria-hidden="true"></i>
                            <span><input type="text" placeholder="用户名/手机号" class="inputCss" autocomplete="off"
                                         name="account"
                                         id="account"></span>
                        </div>
                        <div class="regist-content-item">
                            <i class="glyphicon glyphicon-lock"></i><span>
                <input type="password" placeholder="密码" class="inputCss" name="password"
                       id="password"></span>
                        </div>
                        <div class="regist-content-itemA">
            <span class="">
                <input type="checkbox" name="rememberMe" checked="checked" class="input_check" id="check3">
                <label
                        for="check3">记住我</label>
                <input id="clinicName" name="clinicName" type="hidden"></span>
                            <span><a href="${request.contextPath}/forget">忘记密码？</a></span>

                        </div>
                        <input id="tel" name="tel" value="${user.tel!''}" type="hidden">
                        <input id="student_account" name="student_account" value="${user.student_account!''}"
                               type="hidden">
                        <input id="loginType" name="loginType" value="${user.loginType!''}" type="hidden">
                        <input id="accessToken" name="accessToken" value="${user.accessToken!''}" type="hidden">
                        <div class="regist-content-itemA">
                            <button type="button" id="confirmlogin" class="btn btn-info" onclick="loginUrl()">登录
                            </button>
                        </div>
<!--                        <div class="regist-content-itemA">-->
<!--                            <button type="button" onclick="toTzbs()" class="btn btn-info goTzbs">体质辨识-->
<!--                            </button>-->
<!--                        </div>-->
                        <div class="er" style="display: none">
                            <img src="${request.contextPath}/img/erweima.png" width="40px">
                        </div>
                    </form>
                </div>
                <div role="tabpanel" class="tab-pane active" id="messageLogin">
                    <div class="regist-content-item">
                        <i class="fa fa-phone" aria-hidden="true"></i>
                        <span><input type="text" placeholder="请输入手机号码" id="telphone" name="tel" class="inputCss"></span>

                    </div>
                    <div class="regist-content-itemB">
                        <label>
                            <i class="fa fa-get-pocket"></i>
                            <span><input type="text" placeholder="请输入验证码" id="code" name="code" class="inputCss"></span>
                        </label>
                        <button style="background: #5bc0de" class="btn btn-primary" onclick="getCode(this)">获取验证码</button>
                    </div>
                    <div class="regist-content-itemA">
                        <button id="loginMessage" type="button" onclick="loginUrl()" class="btn btn-info">登录
                        </button>
                    </div>
<!--                    <div class="regist-content-itemA">-->
<!--                        <button style=""  type="button" onclick="toTzbs()" class="btn btn-info goTzbs">体质辨识-->
<!--                        </button>-->
<!--                    </div>-->
<!--                    <div class="regist-content-itemA">-->
<!--                        <button style=""  type="button" onclick="toNcp()" class="btn btn-info goTzbs">新冠康复-->
<!--                        </button>-->
<!--                    </div>-->
<!--                    <div class="regist-content-itemA">-->
<!--                        <button style=""  type="button" onclick="toWeightManage()" class="btn btn-info goTzbs">体重管理-->
<!--                        </button>-->
<!--                    </div>-->

                </div>
                <div class="others">
                    <div class="otherItem" onclick="toTzbs()">
                        <img src="img/tzbs.png">
                        <p>体质辨识</p>
                    </div>
                    <div class="otherItem" onclick="toNcp()">
                        <img src="img/xgkf.png" />
                        <p>新冠康复</p>
                    </div>
                    <div class="otherItem" onclick="toWeightManage()">
                        <img src="img/tzgl.png" />
                        <p>体重管理</p>
                    </div>
                    <div class="otherItem" onclick="toQuestionnaire()">
                        <img src="img/wjdc.png" />
                        <p>慢病管理</p>
                    </div>
                </div>
                <style>
                    .goTzbs{
                        background: #FF8B1A;
                        border-color: #FF8B1A;
                    }
                    .others{
                        overflow: hidden;
                        margin-top: 30px;
                    }
                    .otherItem{
                        width: 25%;
                        float: left;
                        text-align: center;
                    }
                    .otherItem img{
                        width: 40px;
                    }
                    .otherItem p{
                        color: #909090;
                    }
                </style>
                <script>
                    function toTzbs() {
                        //跳转到体质辨识界面
                        location.href = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx8afddcedebe45f0d&redirect_uri=http://wx.cddmi.cn/Home/WeiXinWeb&response_type=code&scope=snsapi_base&state=1030#wechat_redirect";
                    }
                    function toNcp() {
                        //跳转到新冠康复界面
                        location.href = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx8afddcedebe45f0d&redirect_uri=http://wx.cddmi.cn/Home/WeiXinWeb&response_type=code&scope=snsapi_base&state=XGKF#wechat_redirect";
                    }
                    function toWeightManage() {
                        // 跳转到体重管理
                        location.href = "http://weightmanage.bianfusou11.cn";
                    }
                    function toQuestionnaire() {
                        // 跳转到问卷调查
                        location.href = "http://questionnaire.bianfusou11.cn/";
                    }

                </script>
                <div class="erweima">
                    <div id="qrCodeHolder" class="img" style="min-height: 200px">
                    </div>
                    <p style="text-align:center;">请使用微信扫描二维码登录</p>
                    <div class="er">
                        <img src="${request.contextPath}/img/form.png" width="50px">
                    </div>
                </div>
            </div>
        </div>
        <div id="chooseClinics">
            <p>选择诊所</p>
        </div>
    </div>

    <script src="metronic/js/jquery.min.js" type="text/javascript"></script>
    <script src="js/jquery.form.js" type="text/javascript"></script>
    <script src="metronic/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="layui/layui.js" type="text/javascript"></script>
    <!--<script src="js/jquery.i18n.properties.min.js" type="text/javascript"></script>-->
    <script>
        /*获取短信验证码*/
        function getCode(obj) {
            var interval;
            var i = 60;
            if ($(obj).hasClass("btn-primary")) {
                //这里写短信验证接口
                //发送短信
                var phone = $("#telphone").val();
                if (!(/^1[3456789]\d{9}$/.test(phone))) {
                    alert("手机号码有误，请重填");
                    return false;
                }
                $.ajax({
                    url: "${request.contextPath}/sendSms",
                    data: {
                        "phone": phone
                    },
                    success: function (e) {
                        if (!e.code) {
                            layer.msg("消息发送成功");
                        } else {
                            layer.msg("消息发送失败！");
                            //TODO 这里要重置倒计时
                        }
                    },
                    error: function (e) {
                        alert(e);
                        //TODO 这里要重置倒计时
                    }
                })
                interval = setInterval(function () {
                    i--;
                    if (i > 0) {
                        $(obj).removeClass("btn-primary").addClass("btn-default").text(i + "s后重新获取");
                    } else {
                        $(obj).removeClass("btn-default").addClass("btn-primary").text("重新获取");
                        clearInterval(interval);
                    }
                }, 1000)
            }

        }

        var booleanUser = '${isEmpty(user)}'
        if (!booleanUser) {
            $("#confirmlogin").click();
        }
        // console.log(booleanUser)
        var timestamp = new Date().getTime();
        var account = '', password = '', clinics = '';
        var loginData = {
            account: account,
            password: password,
            clinicId: '',
            clinicName: '',
            rememberMe: true
        };
        // console.log(timestamp);
        //加载layer提示插件
        layui.use(['layer', 'layer'], function () {
            var layer = layui.layer,
                layer = layui.layer;
        });

        $(function () {
            //回显信息
            var ybuser = getCookie('ybuser');
            var ybuserP = getCookie('ybuserP');
            if ('' != ybuser && ybuser != null) {
                $("#account").val(ybuser);
                $("#password").val(ybuserP);
                //验证是否为手机号
                $("#telphone").val(ybuser)
            }

            //登录二维码 todo
            // $("#qrCodeHolder").load("${request.contextPath}/interface/loginQRCode?timestamp=" + timestamp);
            // 设置每次ajax开始都要加载等待图片，每次结束关闭等待图片
            $.ajaxSetup({
                beforeSend: function (xhr) {
                    layer.load(2, {shade: [0.1, "#000"], shadeClose: true, scrollbar: false});
                },
                complete: function () {
                    layer.closeAll('loading');
                }
            });

        });

        //登录
        function login(clinicName, clinicId) {
            var url = "${request.contextPath}/userlogin";
            loginData.clinicId = clinicId;
            loginData.clinicName = clinicName;
            loginData.rememberMe = $("#check3").val();
            loginUrl(url, loginData);
        }

        function loginUrl() {
            //登录类型
            var types = $("#login-type > li.active > a");
            // console.log(types[0].innerText)
            if (types[0].innerText == "短信验证登录") {
                var phone = $("#telphone").val();
                $("#account").val(phone);
                var code = $("#code").val();
                $.ajax({
                    url: "${request.contextPath}/userlogin",
                    type: "POST",
                    async: false,
                    data: {
                        account: phone,
                        password: code,
                        loginType: types[0].innerText
                    },
                    success: function (response) {
                        if (response.status == "T") {
                            setCookie('ybuser', $("#account").val(), 10000); //保存帐号到cookie，有效期7天
                            if (loginData.rememberMe == true) {
                                setCookie('ybuserP', $("#password").val(), 10000); //保存帐号到cookie，有效期7天
                            } else {
                                setCookie('ybuserP', '', 0);
                            }
                            var storage = window.localStorage;
                            //获取个性化设置
                            $.ajax({
                                url: "${request.contextPath}/findUserIndividual",
                                type: "post",
                                data: {
                                    account: $("#account").val()
                                },
                                success: function (rs) {
                                    storage.setItem("theme", rs.theme);
                                    storage.setItem("input", rs.input);
                                }
                            })
                            //获取个性化设置end
                            var url = "${request.contextPath}/getallbasedata?userid=" + $("#account").val();
                            $.post(url, function (data) {
                                storage.setItem("users", "[]");
                                storage.setItem("helps", "[]");
                                storage.setItem("materials", JSON.stringify(data.materials));
                                storage.setItem("usages", JSON.stringify(data.usages));
                                storage.setItem("dosages", JSON.stringify(data.dosages));
                                storage.setItem("eighteenNinteens", JSON.stringify(data.eighteenNinteens));
                                chooseClinic();
                            });

                        } else {
                            layer.msg(response.content)
                        }
                    },
                    error: function (e) {
                        alert(JSON.stringify(e))
                    }
                })
            } else {
                $("#loginForm").ajaxSubmit(function (response) {
                    if (response.status == "T") {
                        setCookie('ybuser', $("#account").val(), 10000); //保存帐号到cookie，有效期7天
                        if (loginData.rememberMe == true) {
                            setCookie('ybuserP', $("#password").val(), 10000); //保存帐号到cookie，有效期7天
                        } else {
                            setCookie('ybuserP', '', 0);
                        }
                        var storage = window.localStorage;
                        //获取个性化设置
                        $.ajax({
                            url: "${request.contextPath}/findUserIndividual",
                            type: "post",
                            data: {
                                account: $("#account").val()
                            },
                            success: function (rs) {
                                storage.setItem("theme", rs.theme);
                                storage.setItem("input", rs.input);
                            }
                        })
                        //获取个性化设置end
                        var url = "${request.contextPath}/getallbasedata?userid=" + $("#account").val();
                        $.post(url, function (data) {
                            storage.setItem("users", "[]");
                            storage.setItem("helps", "[]");
                            storage.setItem("materials", JSON.stringify(data.materials));
                            storage.setItem("usages", JSON.stringify(data.usages));
                            storage.setItem("dosages", JSON.stringify(data.dosages));
                            storage.setItem("eighteenNinteens", JSON.stringify(data.eighteenNinteens));
                            chooseClinic();
                        });

                    } else {
                        layer.msg(response.content)
                    }
                });
            }
        }


        /*###################     webSocket start   todo ######################*/
        var lockReconnect = false;  //避免ws重复连接
        var ws = null;          // 判断当前浏览器是否支持WebSocket
        //本地
        var wsUrl = "ws://210.41.221.78:9030/${request.contextPath}/websocket/login/" + timestamp;

        // createWebSocket(wsUrl);   //连接ws
        function reconnect(url) {
            if (lockReconnect) {
                return;
            }
            lockReconnect = true;
            setTimeout(function () {     //没连接上会一直重连，设置延迟避免请求过多
                createWebSocket(url);
                lockReconnect = false;
            }, 2000);
        }

        //心跳检测
        var heartCheck = {
            timeout: 540000,        //9分钟发一次心跳
            timeoutObj: null,
            serverTimeoutObj: null,
            reset: function () {
                clearTimeout(this.timeoutObj);
                clearTimeout(this.serverTimeoutObj);
                return this;
            },
            start: function () {
                var self = this;
                this.timeoutObj = setTimeout(function () {
                    //这里发送一个心跳，后端收到后，返回一个心跳消息，
                    //onmessage拿到返回的心跳就说明连接正常
                    ws.send("ping");
                    // console.log("ping!");
                    self.serverTimeoutObj = setTimeout(function () {//如果超过一定时间还没重置，说明后端主动断开了
                        ws.close();     //如果onclose会执行reconnect，我们执行ws.close()就行了.如果直接执行reconnect 会触发onclose导致重连两次
                    }, self.timeout)
                }, this.timeout)
            }
        }

        function createWebSocket(url) {
            // console.log(wsUrl);
            try {
                if ('WebSocket' in window) {
                    ws = new WebSocket(url);
                } else if ('MozWebSocket' in window) {
                    ws = new MozWebSocket(url);
                } else {
                    layui.use(['layer'], function () {
                        var layer = layui.layer;
                        layer.alert("您的浏览器不支持websocket协议,建议使用新版谷歌、火狐等浏览器，请勿使用IE10以下浏览器，360浏览器请使用极速模式，不要使用兼容模式！");
                    });
                }
                initEventHandle();
            } catch (e) {
                reconnect(url);
                // console.log(e);
            }
        }

        function initEventHandle() {
            ws.onclose = function () {
                reconnect(wsUrl);
                console.log("llws连接关闭!" + timestamp);
            };
            ws.onerror = function () {
                reconnect(wsUrl);
                console.log("llws连接错误!");
            };
            ws.onopen = function () {
                heartCheck.reset().start();      //心跳检测重置
                console.log("llws连接成功!" + timestamp);
            };
            ws.onmessage = function (event) {    //如果获取到消息，心跳检测重置
                console.log(event);
                heartCheck.reset().start();      //拿到任何消息都说明当前连接是正常的
                var messgess = event.data;
                //收到消息内容 json转对象
                var websocketData = $.parseJSON(messgess);
                if (websocketData.status == "F") {
                    console.log(websocketData.openId);
                    window.location = "${request.contextPath}/regist?openId=" + websocketData.openId;
                } else {
                    console.log(websocketData.topic + "---" + websocketData.data);
                    if ("login" == websocketData.topic) {
                        loginData.account = websocketData.data.account;
                        loginData.password = websocketData.data.pwd;
                        chooseClinic();
                    }
                }

            }
        }

        // 监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
        window.onbeforeunload = function () {
            ws.close();
        };
        /*###################     webSocket end    ######################*/


        //设置cookie
        function setCookie(name, value, day) {
            var date = new Date();
            date.setDate(date.getDate() + day);
            document.cookie = name + '=' + value + ';expires=' + date;
        }

        //获取cookie
        function getCookie(name) {
            var reg = RegExp(name + '=([^;]+)');
            var arr = document.cookie.match(reg);
            if (arr) {
                return arr[1];
            } else {
                return '';
            }
        }


        function userlogin() {
            if (parent.status) {
                reloadPage();
            } else {
                login();
            }
        }

        $(function () {
            $(".pharmacy div").click(function () {
                $(this).toggleClass("active")
                    .siblings("div").removeClass("active");
            })
        });


        /**
         * 重新加载页面
         */
        function reloadPage() {
            layer.confirm('您确定要切换账户吗？<br/>点击【确定】它会清除当前页面数据！新开处方', {
                btn: ['确定', '取消'] //按钮
            }, function () {
                layer.closeAll('dialog');
                login()
            });
        }

        /**
         * 回车 执行登录
         */
        $('#loginForm').bind('keyup', function (event) {
            if (event.keyCode == "13") {
                //回车执行查询
                loginUrl()
            }
        });

        /**
         *
         * type 来源  1.点击登录 2.扫码登录(就不需要赋值了)
         */
        function chooseClinic() {
            $.get('${request.contextPath}/clinics', function (data) {
                if (data.msg != "请选择诊所") {
                    layer.msg(data.msg, {time: '1000'})
                } else if (data.data.length > 1) {
                    layer.open({
                        scrollbar: false,
                        type: 1,
                        title: false,
                        shade: 0.6,
                        shadeClose: false,
                        id: 'Clinics',
                        area: ['40%', '40%'],
                        content: $("#chooseClinics")
                    });
                    $("#chooseClinics span").remove();
                    $.each(data.data, function (i, item) {
                        $("#chooseClinics").append("<span name='" + item.clinicId + "'>" + item.name + "</span>")
                    });
                } else {

                    switchclinics(data.data[0].clinicId, data.data[0].name);
                }
            })
        }

        function switchclinics(clinicId, clinicName) {
            $.ajax({
                url: "${request.contextPath}/switchClinic",
                type: "post",
                data: {
                    clinicId: clinicId,
                    clinicName: clinicName
                },
                success: function (rs) {
                    if (rs == "success") {
                        top.location.href = "/recipelIndex";
                    }
                }
            })
        }

        //todo 选诊所
        $("#chooseClinics").on("click", "span", function () {
            var clinicId = $(this).attr("name");
            var clinicName = $(this).text();
            switchclinics(clinicId, clinicName);
        })

        function isNullOrEmpty(strVal) {
            if (strVal == '' || strVal == null || strVal == undefined) {
                return true;
            } else {
                return false;
            }
        }

        $("form .er").click(function () {
            $(".erweima").show();
            $(".regist-content form").hide();
        })
        $(".erweima .er").click(function () {
            $(".erweima").hide();
            $(".regist-content form").show();
        })
    </script>
</body>
<style>
</style>
